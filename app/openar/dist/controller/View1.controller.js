sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/core/format/NumberFormat","sap/ui/core/format/DateFormat","sap/m/Dialog","sap/m/Button","sap/m/Image","sap/m/MessageBox"],(e,t,o,r,n,i,a,s)=>{"use strict";return e.extend("openar.controller.View1",{onInit:function(){var e=this.getOwnerComponent().getModel();const t=this.getView();const o=t.byId("bar0");t.setBusy(true);if(o){o.attachInitialized(function(){t.setBusy(false)})}else{console.error("SmartFilterBar with ID 'bar0' not found.");t.setBusy(false)}const r=t.byId("table0");if(r){const o=r.getTable();if(o){this.bAuthorizationErrorShown=false;if(e){e.attachRequestFailed(e=>{var t=e.getParameters();if(t.response&&t.response.statusCode===403){o.setNoData("No data available due to authorization restrictions");o.setBusy(false);if(!this.bAuthorizationErrorShown){this.bAuthorizationErrorShown=true;s.error("You do not have the required permissions to access this report.",{title:"Unauthorized Access",id:"messageBoxId1",details:"Permission is required to access this report. Please contact your administrator if you believe this is an error or require access."})}}else{console.error("OData request failed:",t.response)}},this)}else{console.error("Main OData Model not found.")}var n=this.getOwnerComponent().getModel("logo");if(n){var i=n.bindList("/MediaFile");i.requestContexts().then(e=>{if(e.length>0){var t=e[0].getObject();console.log("Manufacturer:",t.MFGName);console.log("File URL:",t.url);var o="";try{o=sap.ui.require.toUrl("openar").replace("/resources/openar","");if(o===".")o="";console.log("âœ… Dynamic Base Path:",o)}catch(e){console.warn("Could not determine application base path via sap.ui.require.toUrl. Using relative path.")}var r=t.url&&t.url.startsWith("/")?t.url:o+(t.url||"");var n=this.getView().byId("logoImage");if(n){n.setSrc(r)}else{console.error("Image control with ID 'logoImage' not found.")}}else{console.log("No media found for this manufacturer.")}}).catch(function(e){console.error("Error fetching logo:",e)})}else{console.warn("Logo model 'logo' not found.")}o.attachEvent("rowsUpdated",this._calculateFooterAndSummary.bind(this))}else{console.error("Inner table within SmartTable 'table0' not found.");t.setBusy(false)}}else{console.error("SmartTable with ID 'table0' not found.");t.setBusy(false)}},_calculateFooterAndSummary:function(){var e=this.byId("table0");if(!e){console.error("SmartTable 'table0' not found in _calculateFooterAndSummary.");return}var o=e.getTable();if(!o){console.error("Inner table not found in _calculateFooterAndSummary.");return}var r=o.getBinding("rows");if(!r||!r.getLength()){console.warn("Table binding 'rows' not ready or has zero length in _calculateFooterAndSummary.");return}var n=r.getContexts(0,r.getLength());if(!n||n.length===0){console.log("No contexts available in _calculateFooterAndSummary.");return}var i={fTotCurrent:0,fTot1to30:0,fTot31to60:0,fTot61to90:0,fTotOver90:0,fTotInvoice:0,fTotAmountPaid:0};n.forEach(function(e){i.fTotCurrent+=this._getValueOrZero(e,"CAL_CURRENT");i.fTot1to30+=this._getValueOrZero(e,"CAL_1_30");i.fTot31to60+=this._getValueOrZero(e,"CAL_31_60");i.fTot61to90+=this._getValueOrZero(e,"CAL_61_90");i.fTotOver90+=this._getValueOrZero(e,"CAL_OVER_90");i.fTotInvoice+=this._getValueOrZero(e,"NETWR");i.fTotAmountPaid+=this._getValueOrZero(e,"TSL")},this);Object.keys(i).forEach(function(e){var t=this._getFooterIndex(e);if(t>0){var o=this.byId("footerText"+t);if(o){var r=this._formatCurrency(i[e]);o.setText(r)}else{console.warn("Footer text element 'footerText"+t+"' not found for key: "+e)}}},this);var a=[{BucketName:"Current",Amount:i.fTotCurrent},{BucketName:"1-30 Days",Amount:i.fTot1to30},{BucketName:"31-60 Days",Amount:i.fTot31to60},{BucketName:"61-90 Days",Amount:i.fTot61to90},{BucketName:"Over 90",Amount:i.fTotOver90}];var s=this.getView().getModel("pieChartModel");if(!s){s=new t;this.getView().setModel(s,"pieChartModel")}s.setData({agingData:a});this._updatePastDue(n);this._updateBalanceOwed(i.fTotInvoice,i.fTotAmountPaid);this._updateOpenInvoices(n);this._updateAvgAge(o)},_getValueOrZero:function(e,t){var o=e.getProperty(t);return o!==null&&o!==undefined?parseFloat(o):0},_formatCurrency:function(e){if(e==null){return""}try{const t=o.getCurrencyInstance({currencyCode:false,groupingEnabled:true,showMeasure:false});return isNaN(e)?"":t.format(e)}catch(t){console.error("Error formatting currency:",t);return String(e)}},_getFooterIndex:function(e){var t={fTotCurrent:1,fTot1to30:2,fTot31to60:3,fTot61to90:4,fTotOver90:5,fTotInvoice:6,fTotAmountPaid:7};return t[e]||0},_updatePastDue:function(e){var t=0;var o=new Date;o.setHours(0,0,0,0);e.forEach(e=>{var r=e.getObject();if(r&&r.NETDT){var n=this._parseDate(r.NETDT);var i=(r.NETWR||0)-(r.TSL||0);if(n&&n<o&&i>0){t+=i}}},this);var r=this._formatAmount(t);var n=this.byId("_IDGenNumericContent2");if(n)n.setText(r)},_updateBalanceOwed:function(e,t){var o=(e||0)-(t||0);var r=this._formatAmount(o);var n=this.byId("_IDGenNumericContent1");if(n)n.setText(r)},_updateOpenInvoices:function(e){var t=e.filter(e=>{var t=e.getObject();if(t){var o=(t.NETWR||0)-(t.TSL||0);return o>0}return false}).length;var o=this.byId("_IDGenNumericContent5");if(o)o.setText(t)},_updateAvgAge:function(e){if(!e)return;var t=e.getBinding("rows");if(!t||!t.getLength())return;var o=t.getContexts(0,t.getLength());if(!o||o.length===0)return;var r=o.filter(e=>{var t=e.getObject();return t&&(t.NETWR||0)-(t.TSL||0)>0});if(r.length===0){var n=this.byId("_IDGenNumericContent4");if(n)n.setText("0.0");return}var i=r.reduce((e,t)=>{var o=t.getObject();return e+(o&&o.CAL_AGE?parseFloat(o.CAL_AGE):0)},0);var a=i/r.length;var n=this.byId("_IDGenNumericContent4");if(n)n.setText(a.toFixed(1))},_formatAmount:function(e){if(e==null)return"$0.00";e=parseFloat(e);if(isNaN(e))return"$0.00";if(Math.abs(e)>=1e6)return"$"+(e/1e6).toFixed(1)+"M";if(Math.abs(e)>=1e3)return"$"+(e/1e3).toFixed(1)+"K";return"$"+e.toFixed(2)},_parseDate:function(e){if(!e)return null;let t=null;if(typeof e==="string"&&e.length===8&&/^\d{8}$/.test(e)){const o=e.substring(0,4);const r=e.substring(4,6);const n=e.substring(6,8);t=new Date(Date.UTC(parseInt(o,10),parseInt(r,10)-1,parseInt(n,10)))}else if(e instanceof Date){t=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate()))}if(t&&!isNaN(t.getTime())){return t}else{console.warn("Could not parse date:",e);return null}},onInvoiceClick:function(e){const t=e.getSource()?e.getSource().getText():null;if(!t){console.error("Could not get invoice number from event source.");sap.m.MessageToast.show("Cannot load invoice details.");return}const o=`/mock-api/invoices/${t}`;this._fetchInvoiceImage(o).then(e=>{if(e){this._showInvoiceDialog(e,t)}else{throw new Error("Invalid image URL received.")}}).catch(e=>{console.error("Error fetching/showing invoice:",e);sap.m.MessageToast.show(`Failed to load invoice ${t}.`)})},_fetchInvoiceImage:function(e){console.log("Fetching invoice image from:",e);return new Promise((e,t)=>{setTimeout(()=>{e("https://via.placeholder.com/600x800.png?text=Invoice+Image")},500)})},_showInvoiceDialog:function(e,t){if(this.oInvoiceDialog){this.oInvoiceDialog.destroy()}this.oInvoiceDialog=new n({title:`Invoice ${t||""}`,contentWidth:"auto",contentHeight:"70%",verticalScrolling:true,content:new a({src:e,width:"100%",densityAware:false,decorative:false,alt:`Image for Invoice ${t||""}`}),buttons:[new i({text:"Download",icon:"sap-icon://download",press:()=>this._downloadImage(e,`Invoice_${t||"Image"}.png`)}),new i({text:"Print",icon:"sap-icon://print",press:()=>this._printImage(e)}),new i({text:"Close",type:sap.m.ButtonType.Emphasized,press:()=>{this.oInvoiceDialog.close()}})],afterClose:()=>{if(this.oInvoiceDialog){this.oInvoiceDialog.destroy();this.oInvoiceDialog=null}}});this.oInvoiceDialog.open()},_downloadImage:function(e,t){const o=document.createElement("a");o.href=e;o.download=t||"invoice_image.png";document.body.appendChild(o);o.click();document.body.removeChild(o)},_printImage:function(e){try{const t=window.open("","_blank","height=600,width=800");if(!t){s.warning("Could not open print window. Please check your browser's pop-up settings.");return}t.document.write("<html><head><title>Print Invoice</title>");t.document.write("<style>@media print { body { margin: 0; } img { max-width: 100%; height: auto; display: block; } }</style>");t.document.write("</head><body>");t.document.write(`<img src='${e}' onload='window.print(); window.close();' onerror='window.close(); alert("Could not load image for printing.");' />`);t.document.write("</body></html>");t.document.close()}catch(e){console.error("Error opening print window:",e);s.error("Could not open print window. Please try again or check browser settings.")}}})});
//# sourceMappingURL=View1.controller.js.map