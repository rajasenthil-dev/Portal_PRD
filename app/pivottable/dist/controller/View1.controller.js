sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageToast"],function(e,t,o,n){"use strict";return e.extend("pivottable.controller.View1",{onInit:function(){const e=this.getOwnerComponent().getRouter();e.getRoute("RouteView1").attachPatternMatched(this._onPatternMatched,this);this._oSmartTable=this.byId("table0");const t=this.getView().byId("table0");const o=t.getTable();this._oSmartTable.attachInitialise(this._onSmartTableInit,this);this._oSmartTable.attachBeforeRebindTable(this._onBeforeRebindTable,this);o.attachEvent("rowsUpdated",this._calculateTotals.bind(this))},_refreshUserModel:async function(){const e=this.getOwnerComponent().getModel("userModel");var t=sap.ui.require.toUrl("salesbycus").split("/resources")[0];if(t==="."){t=""}const o=t+"/user-api/attributes";try{const t=await fetch(o);const n=await t.json();e.setData(n);console.log("✅ User model refreshed:",n)}catch(e){console.error("❌ Failed to fetch user info",e)}},_fetchAndSetLogo:function(){const e=this.getView();const t=this.getOwnerComponent().getModel("userModel");const o=t?t.getData():{};const n=o.ManufacturerNumber;const s=e.byId("logoImage");var a=sap.ui.require.toUrl("salesbycus").split("/resources")[0];if(a==="."){a=""}const i=a+"/images/MCKCAN1.jpg";if(!n){console.warn("No ManufacturerNumber in user model. Showing fallback logo.");s.setSrc(i);return}const r=this.getOwnerComponent().getModel("logo");const l=new sap.ui.model.Filter("manufacturerNumber","EQ",n);const c=r.bindList("/MediaFile",undefined,undefined,[l]);c.requestContexts().then(function(e){if(e&&e.length>0){const t=e[0].getObject();const o=t.url.replace(/^.*(?=\/odata\/v4\/media)/,"");const n=a+o;s.setSrc(n)}else{console.warn("No matching logo found. Fallback image used.");s.setSrc(i)}}.bind(this)).catch(function(e){console.error("Binding error:",e);s.setSrc(i)}.bind(this))},_onPatternMatched:async function(){await this._refreshUserModel();console.log("RouteView1 pattern matched – fetching logo...");this._fetchAndSetLogo()},_onSmartTableInit:function(){this._oTable=this._oSmartTable.getTable()},onFilterSelect:function(e){this._sSelectedKey=e.getParameter("key");this._oSmartTable.rebindTable()},_onBeforeRebindTable:function(e){const t=e.getParameter("bindingParams");const o=[];switch(this._sSelectedKey){case"Ladega":o.push(new sap.ui.model.Filter("MAKTX",sap.ui.model.FilterOperator.Contains,"LEDAGA"));break;case"SIGNIFOR":o.push(new sap.ui.model.Filter("MAKTX",sap.ui.model.FilterOperator.Contains,"SIGNIFOR"));break;case"Cystadrops":o.push(new sap.ui.model.Filter("MAKTX",sap.ui.model.FilterOperator.Contains,"CYSTADROP"));break;default:break}t.filters.push.apply(t.filters,o)},formatOrDash:function(e){if(e==="00000000"||!e){return"--"}else{return e?e:"--"}},_calculateTotals:function(){const e=this.getView().byId("table0");const t=e.getTable();const o=t.getBinding("rows");if(!o){console.warn("Table binding is missing.");this._updateTile("FooterText1","0");return}const n=o.getContexts(0,o.getLength());if(!n||n.length===0){console.warn("Data is not available for calculation.");this._updateTile("FooterText1","0");return}const s=n.reduce((e,t)=>{const o=t.getObject();if(!o)return e;const n=parseFloat(o.QUANTITY_FKIMG||0);e.unitsTotal+=n;e.quantityTotal+=n;return e},{quantityTotal:0});const a=this.formatLargeNumber?this.formatLargeNumber(s.quantityTotal):s.quantityTotal;this._updateTile("FooterText1",a)},_updateTile:function(e,t){const o=this.getView().byId(e);if(o){if(o.setText){o.setText(t)}else if(o.getContent&&o.getContent()&&o.getContent().setText){o.getContent().setText(t)}else{console.warn("Tile or its content does not have a setText method:",e)}}else{console.warn("Tile not found:",e)}}})});
//# sourceMappingURL=View1.controller.js.map