sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/core/format/FileSizeFormat","sap/m/MessageBox"],function(e,t,r,a,i){"use strict";return e.extend("admindash.controller.View1",{onInit:function(){this.oUploadSet=this.byId("fileUploader");this._oModel=this.getOwnerComponent().getModel();this.getView().setModel(new r({fileData:null,csrfToken:null,manufacturerNumber:"",mfgName:"",existingManufacturers:[],existingMfgNames:[]}),"ui");this._binding=null;this._fetchExistingManufacturers()},onBeforeRendering:function(){this._fetchCSRFToken()},_fetchExistingManufacturers:function(){var e=sap.ui.require.toUrl("admindash").split("/resources")[0];if(e==="."){e=""}return fetch(e+"/odata/v4/media/MediaFile").then(e=>e.json()).then(e=>{var t=e.value.map(e=>e.manufacturerNumber);var r=e.value.map(e=>e.MFGName);this.getView().getModel("ui").setProperty("/existingManufacturers",t);this.getView().getModel("ui").setProperty("/existingMfgNames",r)}).catch(e=>console.error("Error fetching manufacturers:",e))},onChange:function(e){var t=e.getParameter("files")?.[0];var r=this.getView().getModel("ui");if(t){r.setProperty("/fileData",{file:t,fileName:t.name,fileSize:a.getInstance({binaryFilesize:false,maxFractionDigits:1,maxIntegerDigits:3}).format(t.size),fileType:t.type})}else{r.setProperty("/fileData",null)}},onOpenDialog:function(){this.getView().byId("addManufacturerDialog").open()},onCloseDialog:function(){this.getView().byId("addManufacturerDialog").close()},onUploadPress:async function(){var e=this.getView().getModel("ui");var t=e.getProperty("/fileData/file");var r=e.getProperty("/manufacturerNumber");var a=e.getProperty("/mfgName");var o=e.getProperty("/csrfToken");var n=e.getProperty("/existingManufacturers").map(e=>e.toLowerCase());var s=e.getProperty("/existingMfgNames").map(e=>e.toLowerCase());if(n.includes(r.toLowerCase())){i.error("This Manufacturer Number already exists.");return}if(s.includes(a.toLowerCase())){i.error("This Manufacturer Name already exists.");return}if(!this._validateUploadInputs(r,a,t))return;try{if(!this._binding){const e=await this._createDraft(r,a,t.name,t.type,o);if(e?.context){this._binding=this.getView().getModel().bindContext(e.context.getPath(),null,{$$updateGroupId:"UploadGroup"})}}await this._updateDraftWithContent(this._binding.getPath(),t,t.type,t.name,o);await this._activateDraft(this._binding.getPath(),o);i.success("File uploaded successfully.");this._resetForm();this.onCloseDialog()}catch(e){i.error("Error during upload process: "+e.message)}},_fetchCSRFToken:function(){var e=sap.ui.require.toUrl("admindash").split("/resources")[0];if(e==="."){e=""}return fetch(e+"/odata/v4/media/",{method:"GET",headers:{"X-CSRF-Token":"Fetch"}}).then(e=>{if(!e.ok)throw new Error("Failed to fetch CSRF token");this.getView().getModel("ui").setProperty("/csrfToken",e.headers.get("x-csrf-token"))}).catch(e=>console.error("Error fetching CSRF token: ",e))},_validateUploadInputs:function(e,t,r){if(!e)return i.error("Please enter a Manufacturer Number."),false;if(!t)return i.error("Please enter an MFG Name."),false;if(!r)return i.error("Please choose a file to upload."),false;return true},_resetForm:function(){var e=this.getView().getModel("ui");this.byId("fileUploader").clear();e.setProperty("/fileData",null);e.setProperty("/manufacturerNumber","");e.setProperty("/mfgName","");this.getView().getModel().refresh();this._binding=null;this.byId("idMediaFilesTable").removeSelections(true)},_createDraft:function(e,t,r,a,i){var o=sap.ui.require.toUrl("admindash").split("/resources")[0];if(o==="."){o=""}return fetch(o+"/odata/v4/media/MediaFile",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":i},body:JSON.stringify({manufacturerNumber:e,MFGName:t,fileName:r,mediaType:a})}).then(e=>e.json()).then(e=>({context:{getPath:()=>`/MediaFile(ID=${e.ID},IsActiveEntity=false)`}})).catch(e=>{throw new Error("Failed to create draft: "+e.message)})},_updateDraftWithContent:async function(e,t,r,a,o){try{const i=await fetch(this._oModel.sServiceUrl+e+"/content",{method:"PUT",headers:{"X-CSRF-Token":o,"Content-Type":r,slug:a},body:t});console.log("Server Response Status:",i.status);if(!i.ok){throw new Error(`Failed to upload file. Server responded with status: ${i.status}`)}let n=null;let s=null;if(i.status===204){console.warn("Server returned 204 No Content. Constructing file URL manually...")}else{const e=await i.text();console.log("Raw server response:",e);if(e){try{const t=JSON.parse(e);s=t?.ID}catch(e){console.warn("Response is not valid JSON.")}}}let l=e.replace("IsActiveEntity=false","IsActiveEntity=true");n=this._oModel.sServiceUrl+l+"/content";console.log("Final file URL:",n);this.getView().getModel("ui").setProperty("/fileData/fileUrl",n);const u=await fetch(this._oModel.sServiceUrl+e,{method:"PATCH",headers:{"X-CSRF-Token":o,"Content-Type":"application/json"},body:JSON.stringify({url:n})});if(!u.ok){throw new Error(`Failed to update file URL in backend. Status: ${u.status}`)}console.log("âœ… File URL successfully updated in backend.")}catch(e){console.error("Upload error:",e.message);i.error("Upload error: "+e.message)}},_activateDraft:function(e,t){var r=sap.ui.require.toUrl("admindash").split("/resources")[0];if(r==="."){r=""}return fetch(`${r}/odata/v4/media${e}/Media.draftActivate`,{method:"POST",headers:{"X-CSRF-Token":t,"Content-Type":"application/json"}}).then(e=>{if(!e.ok)throw new Error("Failed to activate draft")}).catch(e=>{throw new Error("Error activating draft: "+e.message)})},onTypeMissmatch:function(){i.error("Invalid file type. Allowed types are: txt, pdf, docx, jpg, png, jpeg")},onManufacturerNumberLiveChange:function(e){var t=e.getParameter("value");var r=e.getSource();var a=this.getView().getModel("ui");var i=a.getProperty("/existingManufacturers");if(/[a-zA-Z]/.test(t)){r.setValueState("Error");r.setValueStateText("Manufacturer Number should not contain letters.")}else{r.setValueState("None")}if(i.includes(t)){r.setValueState("Error");r.setValueStateText("This Manufacturer Number already exists.")}else{r.setValueState("None")}},onManufacturerNameLiveChange:function(e){var t=e.getParameter("value");var r=e.getSource();var a=this.getView().getModel("ui");var i=a.getProperty("/existingMfgNames").map(e=>e.toLowerCase());if(i.includes(t)){r.setValueState("Error");r.setValueStateText("This Manufacturer Name already exists.")}else{r.setValueState("None")}},onDeleteDraft:function(){var e=this.byId("idMediaFilesTable");var t=e.getSelectedItems();if(!t.length){i.warning("Please select at least one draft to delete.");return}i.warning("Make sure ONLY entries you want to delete are selected. Once deleted, this action cannot be undone.",{actions:[i.Action.OK,i.Action.CANCEL],emphasizedAction:i.Action.OK,onClose:e=>{if(e===i.Action.OK){this._deleteDrafts(t)}}})},_deleteDrafts:function(e){var r=this.getView().getModel();var a=[];e.forEach(e=>{var t=e.getBindingContext();a.push(t.delete())});Promise.all(a).then(()=>{t.show("Selected items deleted successfully.");r.refresh()}).catch(e=>{i.error("Error deleting items: "+e.message)})}})});
//# sourceMappingURL=View1.controller.js.map